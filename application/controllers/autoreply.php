<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');class Autoreply extends Controller {	function Autoreply()	{		parent::Controller();			$this->load->model('Sms_model');	}		function index()	{		echo "<h1>Running SMS Service...</h1>";		$query1 = $this->Sms_model->getInbox();		if ($query1):			$msg = strtoupper($query1->TextDecoded);			$no_tujuan = $query1->SenderNumber;			$pecah = explode(" ", $msg);			if ($pecah[0] == "JADWAL")://JADWAL				$pass = $pecah[1];				$query2 = $this->Sms_model->getPass($pass);				if ($query2):					foreach ($query2 as $passwd):					$dosennya = $passwd->id_dosen;					$query4 = $this->Sms_model->jadwal($dosennya);					$no_tujuan = $query1->SenderNumber; 					$no=1;										$baca = $this->Sms_model->getBalasan("JADWAL");					if ($baca):						foreach ($baca as $balasan):														ob_start();							foreach ($query4 as $jadwal):								$find = array("[nomor]","[matakuliah]","[kelas]","[hari]","[jam]","[pass]");								$replace = array($no++,$jadwal->matakuliah,$jadwal->kelas,$jadwal->hari,$jadwal->waktu,$jadwal->kode_matakuliah);								echo str_replace($find,$replace,$balasan->pesan);							endforeach;														$reply = ob_get_contents();							ob_end_clean();						endforeach;					endif;					if (strlen($reply) <= 160):						$data = array(							'CreatorID' => 'system',							'DestinationNumber' => $no_tujuan,							'TextDecoded' => $reply							);						$this->Sms_model->makeOutbox($data);					else:						exec('c:\gammu\gammu-smsd-inject.exe -c c:\gammu\smsdrc EMS '.$no_tujuan.' -text "'.$reply.'"');					endif;					endforeach;				else:					$no_tujuan = $query1->SenderNumber;					$baca = $this->Sms_model->getBalasan("SALAH (PASSWORD)");					if ($baca):						foreach ($baca as $balasan):							$reply = $balasan->pesan;						endforeach;					endif;					$data = array(						'CreatorID' => 'system',						'DestinationNumber' => $no_tujuan,						'TextDecoded' => $reply						);					$this->Sms_model->makeOutbox($data);				endif;			elseif ($pecah[0] == "KOSONG")://KOSONG				$pass = $pecah[1];				$query2 = $this->Sms_model->getPass($pass);				if ($query2):					$kode = $pecah[2];					$query3 = $this->Sms_model->getKuliah($kode);					if ($query3):						foreach ($query3 as $kodemakul):							$kode_matakuliah = $kodemakul->kode_matakuliah;							$tujuan = $this->Sms_model->getMahasiswa($kode_matakuliah);							if ($tujuan):								foreach ($tujuan as $target):									$no_tujuan = $target->hp;									$baca = $this->Sms_model->getBalasan("KOSONG");									if ($baca):										foreach ($baca as $balasan):											$find = array("[matakuliah]","[kelas]","[hari]","[jam]");											$replace = array($kodemakul->matakuliah,$kodemakul->kelas,$kodemakul->hari,$kodemakul->waktu);												$reply = str_replace($find,$replace,$balasan->pesan);										endforeach;									endif;									if (strlen($reply) <= 160):										$data = array(											'CreatorID' => 'system',											'DestinationNumber' => $no_tujuan,											'TextDecoded' => $reply										);										$kirim = $this->Sms_model->makeOutbox($data);										$kirim = true;									else:										exec('c:\gammu\gammu-smsd-inject.exe -c c:\gammu\smsdrc EMS '.$no_tujuan.' -text "'.$reply.'"');										$kirim = true;									endif;								endforeach;							endif;						endforeach;						if ($kirim == true):							$no_tujuan = $query1->SenderNumber;							$baca = $this->Sms_model->getBalasan("SUKSES");							if ($baca):								foreach ($baca as $balasan):									$reply = $balasan->pesan;								endforeach;							endif;							$data = array(								'CreatorID' => 'system',								'DestinationNumber' => $no_tujuan,								'TextDecoded' => $reply							);							$this->Sms_model->makeOutboxNotification($data);						else:							$no_tujuan = $query1->SenderNumber;							$baca = $this->Sms_model->getBalasan("GAGAL");							if ($baca):								foreach ($baca as $balasan):									$reply = $balasan->pesan;								endforeach;							endif;							$data = array(								'CreatorID' => 'system',								'DestinationNumber' => $no_tujuan,								'TextDecoded' => $reply							);							$this->Sms_model->makeOutboxNotification($data);						endif;					else:						$no_tujuan = $query1->SenderNumber;						$baca = $this->Sms_model->getBalasan("SALAH (KODE MATAKULIAH)");						if ($baca):							foreach ($baca as $balasan):								$reply = $balasan->pesan;							endforeach;						endif;						$data = array(							'CreatorID' => 'system',							'DestinationNumber' => $no_tujuan,							'TextDecoded' => $reply						);						$this->Sms_model->makeOutbox($data);					endif;				else:					$no_tujuan = $query1->SenderNumber;					$baca = $this->Sms_model->getBalasan("SALAH (PASSWORD)");					if ($baca):						foreach ($baca as $balasan):							$reply = $balasan->pesan;						endforeach;					endif;					$data = array(						'CreatorID' => 'system',						'DestinationNumber' => $no_tujuan,						'TextDecoded' => $reply						);					$this->Sms_model->makeOutbox($data);				endif;						elseif ($pecah[0] == "GANTI")://GANTI				$pass = $pecah[1];				$query2 = $this->Sms_model->getPass($pass);				if ($query2):					$kode = $pecah[2];					$query3 = $this->Sms_model->getKuliah($kode);					if ($query3):						foreach ($query3 as $kodemakul):							$kode_matakuliah = $kodemakul->kode_matakuliah;							$tujuan = $this->Sms_model->getMahasiswa($kode_matakuliah);							if ($tujuan):								$hari = $pecah[3];								$jam = $pecah[4];								$pola_hari = "/^([a-zA-Z])/i";								$pola_jam = "/^([0-9:])/i";								if (($hari == "")||($jam == "")||(!preg_match($pola_hari, $hari))||(!preg_match($pola_jam, $jam))):									$no_tujuan = $query1->SenderNumber;									$baca = $this->Sms_model->getBalasan("GANTI SALAH (FORMAT HARI ATAU JAM)");									if ($baca):										foreach ($baca as $balasan):											$reply = $balasan->pesan;										endforeach;									endif;									$data = array(										'CreatorID' => 'system',										'DestinationNumber' => $no_tujuan,										'TextDecoded' => $reply									);									$kirim = $this->Sms_model->makeOutbox($data);								else:									foreach ($tujuan as $target):										$no_tujuan = $target->hp;										$baca = $this->Sms_model->getBalasan("GANTI");										if ($baca):											foreach ($baca as $balasan):												$find = array("[matakuliah]","[kelas]","[hari]","[jam]","[ganti_hari]","[ganti_jam]");												$replace = array($kodemakul->matakuliah,$target->kelas,$target->hari,$target->waktu,$hari,$jam);													$reply = str_replace($find,$replace,$balasan->pesan);											endforeach;										endif;										if (strlen($reply) <= 160):											$data = array(												'CreatorID' => 'system',												'DestinationNumber' => $no_tujuan,												'TextDecoded' => $reply											);											$kirim = $this->Sms_model->makeOutbox($data);											$kirim = true;										else:											exec('c:\gammu\gammu-smsd-inject.exe -c c:\gammu\smsdrc EMS '.$no_tujuan.' -text "'.$reply.'"');											$kirim = true;										endif;									endforeach;									if ($kirim == true):										$no_tujuan = $query1->SenderNumber;										$baca = $this->Sms_model->getBalasan("SUKSES");										if ($baca):											foreach ($baca as $balasan):												$reply = $balasan->pesan;											endforeach;										endif;										$data = array(											'CreatorID' => 'system',											'DestinationNumber' => $no_tujuan,											'TextDecoded' => $reply										);										$this->Sms_model->makeOutboxNotification($data);									else:										$no_tujuan = $query1->SenderNumber;										$baca = $this->Sms_model->getBalasan("GAGAL");										if ($baca):											foreach ($baca as $balasan):												$reply = $balasan->pesan;											endforeach;										endif;										$data = array(											'CreatorID' => 'system',											'DestinationNumber' => $no_tujuan,											'TextDecoded' => $reply										);										$this->Sms_model->makeOutboxNotification($data);									endif;								endif;							endif;						endforeach;					else:						$no_tujuan = $query1->SenderNumber;						$baca = $this->Sms_model->getBalasan("SALAH (KODE MATAKULIAH)");						if ($baca):							foreach ($baca as $balasan):								$reply = $balasan->pesan;							endforeach;						endif;						$data = array(							'CreatorID' => 'system',							'DestinationNumber' => $no_tujuan,							'TextDecoded' => $reply						);						$this->Sms_model->makeOutbox($data);					endif;				else:					$no_tujuan = $query1->SenderNumber;					$baca = $this->Sms_model->getBalasan("SALAH (PASSWORD)");					if ($baca):						foreach ($baca as $balasan):							$reply = $balasan->pesan;						endforeach;					endif;					$data = array(						'CreatorID' => 'system',						'DestinationNumber' => $no_tujuan,						'TextDecoded' => $reply						);					$this->Sms_model->makeOutbox($data);				endif;					elseif ($pecah[0] == "ONLINE")://ONLINE				$pass = $pecah[1];				$query2 = $this->Sms_model->getPass($pass);				if ($query2):					$kode = $pecah[2];					$query3 = $this->Sms_model->getKuliah($kode);					if ($query3):						foreach ($query3 as $kodemakul):							$kode_matakuliah = $kodemakul->kode_matakuliah;							$tujuan = $this->Sms_model->getMahasiswa($kode_matakuliah);							if ($tujuan):								$jam = $pecah[3];								$pola_jam = "/^([0-9:])/i";								if (($jam == "")||(!preg_match($pola_jam, $jam))):									$no_tujuan = $query1->SenderNumber;									$baca = $this->Sms_model->getBalasan("ONLINE SALAH (FORMAT JAM)");									if ($baca):										foreach ($baca as $balasan):											$reply = $balasan->pesan;										endforeach;									endif;									$data = array(										'CreatorID' => 'system',										'DestinationNumber' => $no_tujuan,										'TextDecoded' => $reply									);									$kirim = $this->Sms_model->makeOutbox($data);								else:									foreach ($tujuan as $target):										$no_tujuan = $target->hp;										$baca = $this->Sms_model->getBalasan("ONLINE");										if ($baca):											foreach ($baca as $balasan):												$find = array("[matakuliah]","[kelas]","[hari]","[jam]","[ganti_jam]");												$replace = array($kodemakul->matakuliah,$target->kelas,$target->hari,$target->waktu,$jam);													$reply = str_replace($find,$replace,$balasan->pesan);											endforeach;										endif;										if (strlen($reply) <= 160):											$data = array(												'CreatorID' => 'system',												'DestinationNumber' => $no_tujuan,												'TextDecoded' => $reply											);											$kirim = $this->Sms_model->makeOutbox($data);											$kirim = true;										else:											exec('c:\gammu\gammu-smsd-inject.exe -c c:\gammu\smsdrc EMS '.$no_tujuan.' -text "'.$reply.'"');											$kirim = true;										endif;									endforeach;									if ($kirim == true):										$no_tujuan = $query1->SenderNumber;										$baca = $this->Sms_model->getBalasan("SUKSES");										if ($baca):											foreach ($baca as $balasan):												$reply = $balasan->pesan;											endforeach;										endif;										$data = array(											'CreatorID' => 'system',											'DestinationNumber' => $no_tujuan,											'TextDecoded' => $reply										);										$this->Sms_model->makeOutboxNotification($data);									else:										$no_tujuan = $query1->SenderNumber;										$baca = $this->Sms_model->getBalasan("GAGAL");										if ($baca):											foreach ($baca as $balasan):												$reply = $balasan->pesan;											endforeach;										endif;										$data = array(											'CreatorID' => 'system',											'DestinationNumber' => $no_tujuan,											'TextDecoded' => $reply										);										$this->Sms_model->makeOutboxNotification($data);									endif;								endif;							endif;						endforeach;					else:						$no_tujuan = $query1->SenderNumber;						$baca = $this->Sms_model->getBalasan("SALAH (KODE MATAKULIAH)");						if ($baca):							foreach ($baca as $balasan):								$reply = $balasan->pesan;							endforeach;						endif;						$data = array(							'CreatorID' => 'system',							'DestinationNumber' => $no_tujuan,							'TextDecoded' => $reply						);						$this->Sms_model->makeOutbox($data);					endif;				else:					$no_tujuan = $query1->SenderNumber;					$baca = $this->Sms_model->getBalasan("SALAH (PASSWORD)");					if ($baca):						foreach ($baca as $balasan):							$reply = $balasan->pesan;						endforeach;					endif;					$data = array(						'CreatorID' => 'system',						'DestinationNumber' => $no_tujuan,						'TextDecoded' => $reply						);					$this->Sms_model->makeOutbox($data);				endif;						elseif ($pecah[0] == "UMUM")://PENGUMUMAN				$pass = $pecah[1];				$query2 = $this->Sms_model->getPass($pass);				if ($query2):					$kode = substr($pecah[2],0,8);					$query3 = $this->Sms_model->getKuliah($kode);					if ($query3):						foreach ($query3 as $kodemakul):							$kode_matakuliah = $kodemakul->kode_matakuliah;							$tujuan = $this->Sms_model->getMahasiswa($kode_matakuliah);							if ($tujuan):									foreach ($tujuan as $target):										$no_tujuan = $target->hp;										$replynya = implode(" ",$pecah);										$isi_pengumuman = strtolower(substr(strrchr($replynya, '#'), 1));										$baca = $this->Sms_model->getBalasan("PENGUMUMAN");										if ($baca):											foreach ($baca as $balasan):												$find = array("[isi_pengumuman]");												$replace = array($isi_pengumuman);													$reply = str_replace($find,$replace,$balasan->pesan);											endforeach;										endif;										if (strlen($reply) <= 160):											$data = array(												'CreatorID' => 'system',												'DestinationNumber' => $no_tujuan,												'TextDecoded' => $reply											);											$kirim = $this->Sms_model->makeOutbox($data);											$kirim = true;										else:											exec('c:\gammu\gammu-smsd-inject.exe -c c:\gammu\smsdrc EMS '.$no_tujuan.' -text "'.$reply.'"');											$kirim = true;										endif;									endforeach;									if ($kirim == true):										$no_tujuan = $query1->SenderNumber;										$baca = $this->Sms_model->getBalasan("SUKSES");										if ($baca):											foreach ($baca as $balasan):												$reply = $balasan->pesan;											endforeach;										endif;										$data = array(											'CreatorID' => 'system',											'DestinationNumber' => $no_tujuan,											'TextDecoded' => $reply										);										$this->Sms_model->makeOutboxNotification($data);									else:										$no_tujuan = $query1->SenderNumber;										$baca = $this->Sms_model->getBalasan("GAGAL");										if ($baca):											foreach ($baca as $balasan):												$reply = $balasan->pesan;											endforeach;										endif;										$data = array(											'CreatorID' => 'system',											'DestinationNumber' => $no_tujuan,											'TextDecoded' => $reply										);										$this->Sms_model->makeOutboxNotification($data);									endif;															endif;						endforeach;					else:						$no_tujuan = $query1->SenderNumber;						$baca = $this->Sms_model->getBalasan("SALAH (KODE MATAKULIAH)");						if ($baca):							foreach ($baca as $balasan):								$reply = $balasan->pesan;							endforeach;						endif;						$data = array(							'CreatorID' => 'system',							'DestinationNumber' => $no_tujuan,							'TextDecoded' => $reply						);						$this->Sms_model->makeOutbox($data);					endif;				else:					$no_tujuan = $query1->SenderNumber;					$baca = $this->Sms_model->getBalasan("SALAH (PASSWORD)");					if ($baca):						foreach ($baca as $balasan):							$reply = $balasan->pesan;						endforeach;					endif;					$data = array(						'CreatorID' => 'system',						'DestinationNumber' => $no_tujuan,						'TextDecoded' => $reply						);					$this->Sms_model->makeOutbox($data);				endif;						else://SALAH				$no_tujuan = $query1->SenderNumber;				$baca = $this->Sms_model->getBalasan("SALAH KEYWORD");				if ($baca):					foreach ($baca as $balasan):						$reply = $balasan->pesan;					endforeach;				endif;				if (strlen($reply) <= 160):				$data = array(						'CreatorID' => 'system',						'DestinationNumber' => $no_tujuan,						'TextDecoded' => $reply						);				$this->Sms_model->makeOutbox($data);				else:					exec('c:\gammu\gammu-smsd-inject.exe -c c:\gammu\smsdrc EMS '.$no_tujuan.' -text "'.$reply.'"');				endif;			endif;						$id = $query1->ID;				$data = array(					'Processed' => 'true'					);				$this->Sms_model->updateInbox($id, $data);		endif;			}	}